/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.data.StoreExplorer"]){dojo._hasResource["dojox.data.StoreExplorer"]=true;dojo.provide("dojox.data.StoreExplorer");dojo.require("dojox.grid.DataGrid");dojo.require("dojox.data.ItemExplorer");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.declare("dojox.data.StoreExplorer",dijit.layout.BorderContainer,{constructor:function $DrS_(_1){dojo.mixin(this,_1);},store:null,stringQueries:false,postCreate:function $DrT_(){var _2=this;this.inherited(arguments);var _3=new dijit.layout.ContentPane({region:"top"}).placeAt(this);function addButton(_4,_5){var _6=new dijit.form.Button({label:_4});_3.containerNode.appendChild(_6.domNode);_6.onClick=_5;return _6;};var _7=_3.containerNode.appendChild(document.createElement("span"));_7.innerHTML="Enter query: &nbsp;";_7.id="queryText";var _8=_3.containerNode.appendChild(document.createElement("input"));_8.type="text";_8.id="queryTextBox";addButton("Query",function(){var _9=_8.value;_2.setQuery(_2.stringQueries?_9:dojo.fromJson(_9));});_3.containerNode.appendChild(document.createElement("span")).innerHTML="&nbsp;&nbsp;&nbsp;";var _a=addButton("Create New",dojo.hitch(this,"createNew"));var _b=addButton("Delete",function(){var _c=_d.selection.getSelected();for(var i=0;i<_c.length;i++){_2.store.deleteItem(_c[i]);}});this.setItemName=function $DrY_(_e){_a.attr("label","<img style='width:12px; height:12px' src='"+dojo.moduleUrl("dijit.themes.tundra.images","dndCopy.png")+"' /> Create New "+_e);_b.attr("label","Delete "+_e);};addButton("Save",function(){_2.store.save({onError:function(_f){alert(_f);}});_2.tree.refreshItem();});addButton("Revert",function(){_2.store.revert();});addButton("Add Column",function(){var _10=prompt("Enter column name:","property");if(_10){_2.gridLayout.push({field:_10,name:_10,formatter:dojo.hitch(_2,"_formatCell"),editable:true});_2.grid.attr("structure",_2.gridLayout);}});var _11=new dijit.layout.ContentPane({region:"center"}).placeAt(this);var _d=this.grid=new dojox.grid.DataGrid({store:this.store});_11.attr("content",_d);_d.canEdit=function $DrZ_(_12,_13){var _14=this._copyAttr(_13,_12.field);return !(_14&&typeof _14=="object")||_14 instanceof Date;};var _15=new dijit.layout.ContentPane({region:"trailing",splitter:true,style:"width: 300px"}).placeAt(this);var _16=this.tree=new dojox.data.ItemExplorer({store:this.store});_15.attr("content",_16);dojo.connect(_d,"onCellClick",function(){var _17=_d.selection.getSelected()[0];_16.setItem(_17);});this.gridOnFetchComplete=_d._onFetchComplete;this.setStore(this.store);},setQuery:function $DrU_(_18){this.grid.setQuery(_18);},_formatCell:function $DrV_(_19){if(this.store.isItem(_19)){return this.store.getLabel(_19)||this.store.getIdentity(_19);}return _19;},setStore:function $DrW_(_1a){this.store=_1a;var _1b=this;var _1c=this.grid;_1c._pending_requests[0]=false;function formatCell(_1d){return _1b._formatCell(_1d);};var _1e=this.gridOnFetchComplete;_1c._onFetchComplete=function $Dra_(_1f,req){var _20=_1b.gridLayout=[];var _21,key,_22,i,j,k,_23=_1a.getIdentityAttributes();for(i=0;i<_23.length;i++){key=_23[i];_20.push({field:key,name:key,_score:100,formatter:formatCell,editable:false});}for(i=0;_22=_1f[i++];){var _24=_1a.getAttributes(_22);for(k=0;key=_24[k++];){var _25=false;for(j=0;_21=_20[j++];){if(_21.field==key){_21._score++;_25=true;break;}}if(!_25){_20.push({field:key,name:key,_score:1,formatter:formatCell,styles:"white-space:nowrap; ",editable:true});}}}_20=_20.sort(function(a,b){return a._score>b._score?-1:1;});for(j=0;_21=_20[j];j++){if(_21._score<_1f.length/40*j){_20.splice(j,_20.length-j);break;}}for(j=0;_21=_20[j++];){_21.width=Math.round(100/_20.length)+"%";}_1c._onFetchComplete=_1e;_1c.attr("structure",_20);var _26=_1e.apply(this,arguments);};_1c.setStore(_1a);this.queryOptions={cache:true};this.tree.setStore(_1a);},createNew:function $DrX_(){var _27=prompt("Enter any properties (in JSON literal form) to put in the new item (passed to the newItem constructor):","{ }");if(_27){try{this.store.newItem(dojo.fromJson(_27));}catch(e){alert(e);}}}});}