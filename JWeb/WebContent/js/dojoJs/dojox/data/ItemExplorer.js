/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.data.ItemExplorer"]){dojo._hasResource["dojox.data.ItemExplorer"]=true;dojo.provide("dojox.data.ItemExplorer");dojo.require("dijit.Tree");dojo.require("dijit.Dialog");dojo.require("dijit.Menu");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.Textarea");dojo.require("dijit.form.Button");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.FilteringSelect");(function(){var _1=function(_2,_3,_4){var _5=_2.getValues(_3,_4);if(_5.length<2){_5=_2.getValue(_3,_4);}return _5;};dojo.declare("dojox.data.ItemExplorer",dijit.Tree,{useSelect:false,refSelectSearchAttr:null,constructor:function $Dnx_(_6){dojo.mixin(this,_6);var _7=this;var _8={};var _9=this.rootModelNode={value:_8,id:"root"};this._modelNodeIdMap={};this._modelNodePropMap={};var _a=1;this.model={getRoot:function $Dny_(_b){_b(_9);},mayHaveChildren:function $Dnz_(_c){return _c.value&&typeof _c.value=="object"&&!(_c.value instanceof Date);},getChildren:function $Dn0_(_d,_e,_f){var _10,_11,_12=_d.value;var _13=[];if(_12==_8){_e([]);return;}var _14=_7.store&&_7.store.isItem(_12,true);if(_14&&!_7.store.isItemLoaded(_12)){_7.store.loadItem({item:_12,onItem:function $Dn1_(_15){_12=_15;enumerate();}});}else{enumerate();}function enumerate(){if(_14){_10=_7.store.getAttributes(_12);_11=_12;}else{if(_12&&typeof _12=="object"){_11=_d.value;_10=[];for(var i in _12){if(_12.hasOwnProperty(i)&&i!="__id"&&i!="__clientId"){_10.push(i);}}}}if(_10){for(var key,k=0;key=_10[k++];){_13.push({property:key,value:_14?_1(_7.store,_12,key):_12[key],parent:_11});}_13.push({addNew:true,parent:_11,parentNode:_d});}_e(_13);};},getIdentity:function $Dn2_(_16){if(!_16.id){if(_16.addNew){_16.property="--addNew";}_16.id=_a++;if(_7.store){if(_7.store.isItem(_16.value)){var _17=_7.store.getIdentity(_16.value);(_7._modelNodeIdMap[_17]=_7._modelNodeIdMap[_17]||[]).push(_16);}if(_16.parent){_17=_7.store.getIdentity(_16.parent)+"."+_16.property;(_7._modelNodePropMap[_17]=_7._modelNodePropMap[_17]||[]).push(_16);}}}return _16.id;},getLabel:function $Dn3_(_18){return _18===_9?"Object Properties":_18.addNew?(_18.parent instanceof Array?"Add new value":"Add new property"):_18.property+": "+(_18.value instanceof Array?"("+_18.value.length+" elements)":_18.value);},onChildrenChange:function $Dn4_(_19){},onChange:function $Dn5_(_1a){}};},postCreate:function $Dn6_(){this.inherited(arguments);dojo.connect(this,"onClick",function(_1b,_1c){this.lastFocused=_1c;if(_1b.addNew){this._addProperty();}else{this._editProperty();}});var _1d=new dijit.Menu({targetNodeIds:[this.rootNode.domNode],id:"contextMenu"});dojo.connect(_1d,"_openMyself",this,function(e){var _1e=dijit.getEnclosingWidget(e.target);if(_1e){var _1f=_1e.item;if(this.store.isItem(_1f.value,true)&&!_1f.parent){_1d.getChildren().forEach(function(_20){_20.attr("disabled",(_20.label!="Add"));});this.lastFocused=_1e;}else{if(_1f.value&&typeof _1f.value=="object"&&!(_1f.value instanceof Date)){_1d.getChildren().forEach(function(_21){_21.attr("disabled",(_21.label!="Add")&&(_21.label!="Delete"));});this.lastFocused=_1e;}else{if(_1f.property&&dojo.indexOf(this.store.getIdentityAttributes(),_1f.property)>=0){this.focusNode(_1e);alert("Cannot modify an Identifier node.");}else{if(_1f.addNew){this.focusNode(_1e);}else{_1d.getChildren().forEach(function(_22){_22.attr("disabled",(_22.label!="Edit")&&(_22.label!="Delete"));});this.lastFocused=_1e;}}}}}});_1d.addChild(new dijit.MenuItem({label:"Add",onClick:dojo.hitch(this,"_addProperty")}));_1d.addChild(new dijit.MenuItem({label:"Edit",onClick:dojo.hitch(this,"_editProperty")}));_1d.addChild(new dijit.MenuItem({label:"Delete",onClick:dojo.hitch(this,"_destroyProperty")}));_1d.startup();},store:null,setStore:function $Dn7_(_23){this.store=_23;var _24=this;if(this._editDialog){this._editDialog.destroyRecursive();delete this._editDialog;}dojo.connect(_23,"onSet",function(_25,_26,_27,_28){var _29,i,_2a=_24.store.getIdentity(_25);_29=_24._modelNodeIdMap[_2a];if(_29&&(_27===undefined||_28===undefined||_27 instanceof Array||_28 instanceof Array||typeof _27=="object"||typeof _28=="object")){for(i=0;i<_29.length;i++){(function(_2b){_24.model.getChildren(_2b,function(_2c){_24.model.onChildrenChange(_2b,_2c);});})(_29[i]);}}_29=_24._modelNodePropMap[_2a+"."+_26];if(_29){for(i=0;i<_29.length;i++){_29[i].value=_28;_24.model.onChange(_29[i]);}}});this.rootNode.setChildItems([]);},setItem:function $Dn8_(_2d){(this._modelNodeIdMap={})[this.store.getIdentity(_2d)]=[this.rootModelNode];this._modelNodePropMap={};this.rootModelNode.value=_2d;var _2e=this;this.model.getChildren(this.rootModelNode,function(_2f){_2e.rootNode.setChildItems(_2f);});},refreshItem:function $Dn9_(){this.setItem(this.rootModelNode.value);},_createEditDialog:function $DoA_(){this._editDialog=new dijit.Dialog({title:"Edit Property",execute:dojo.hitch(this,"_updateItem"),preload:true});this._editDialog.placeAt(dojo.body());this._editDialog.startup();var _30=dojo.doc.createElement("div");var _31=dojo.doc.createElement("label");dojo.attr(_31,"for","property");dojo.style(_31,"fontWeight","bold");dojo.attr(_31,"innerHTML","Property:");_30.appendChild(_31);var _32=new dijit.form.ValidationTextBox({name:"property",value:"",required:true,disabled:true}).placeAt(_30);_30.appendChild(dojo.doc.createElement("br"));_30.appendChild(dojo.doc.createElement("br"));var _33=new dijit.form.RadioButton({name:"itemType",value:"value",onClick:dojo.hitch(this,function(){this._enableFields("value");})}).placeAt(_30);var _34=dojo.doc.createElement("label");dojo.attr(_34,"for","value");dojo.attr(_34,"innerHTML","Value (JSON):");_30.appendChild(_34);var _35=dojo.doc.createElement("div");dojo.addClass(_35,"value");var _36=new dijit.form.Textarea({name:"jsonVal"}).placeAt(_35);_30.appendChild(_35);var _37=new dijit.form.RadioButton({name:"itemType",value:"reference",onClick:dojo.hitch(this,function(){this._enableFields("reference");})}).placeAt(_30);var _38=dojo.doc.createElement("label");dojo.attr(_38,"for","_reference");dojo.attr(_38,"innerHTML","Reference (ID):");_30.appendChild(_38);_30.appendChild(dojo.doc.createElement("br"));var _39=dojo.doc.createElement("div");dojo.addClass(_39,"reference");if(this.useSelect){var _3a=new dijit.form.FilteringSelect({name:"_reference",store:this.store,searchAttr:this.refSelectSearchAttr||this.store.getIdentityAttributes()[0],required:false,value:null,pageSize:10}).placeAt(_39);}else{var _3b=new dijit.form.ValidationTextBox({name:"_reference",value:"",promptMessage:"Enter the ID of the item to reference",isValid:dojo.hitch(this,function(_3c){return true;})}).placeAt(_39);}_30.appendChild(_39);_30.appendChild(dojo.doc.createElement("br"));_30.appendChild(dojo.doc.createElement("br"));var _3d=document.createElement("div");_3d.setAttribute("dir","rtl");var _3e=new dijit.form.Button({type:"reset",label:"Cancel"}).placeAt(_3d);_3e.onClick=dojo.hitch(this._editDialog,"onCancel");var _3f=new dijit.form.Button({type:"submit",label:"OK"}).placeAt(_3d);_30.appendChild(_3d);this._editDialog.attr("content",_30);},_enableFields:function $DoB_(_40){switch(_40){case "reference":dojo.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(_41){dijit.getEnclosingWidget(_41).attr("disabled",true);});dojo.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(_42){dijit.getEnclosingWidget(_42).attr("disabled",false);});break;case "value":dojo.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(_43){dijit.getEnclosingWidget(_43).attr("disabled",false);});dojo.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(_44){dijit.getEnclosingWidget(_44).attr("disabled",true);});break;}},_updateItem:function $DoC_(_45){var _46,_47,val,_48,_49=this._editDialog.attr("title")=="Edit Property";var _4a=this._editDialog;var _4b=this.store;function setValue(){try{var _4c,_4d=[];var _4e=_45.property;if(_49){while(!_4b.isItem(_47.parent,true)){_46=_46.getParent();_4d.push(_47.property);_47=_46.item;}if(_4d.length==0){_4b.setValue(_47.parent,_47.property,val);}else{_48=_1(_4b,_47.parent,_47.property);if(_48 instanceof Array){_48=_48.concat();}_4c=_48;while(_4d.length>1){_4c=_4c[_4d.pop()];}_4c[_4d]=val;_4b.setValue(_47.parent,_47.property,_48);}}else{if(_4b.isItem(_4f,true)){if(!_4b.isItemLoaded(_4f)){_4b.loadItem({item:_4f,onItem:function $DoD_(_50){if(_50 instanceof Array){_4e=_50.length;}_4b.setValue(_50,_4e,val);}});}else{if(_4f instanceof Array){_4e=_4f.length;}_4b.setValue(_4f,_4e,val);}}else{if(_47.value instanceof Array){_4d.push(_47.value.length);}else{_4d.push(_45.property);}while(!_4b.isItem(_47.parent,true)){_46=_46.getParent();_4d.push(_47.property);_47=_46.item;}_48=_1(_4b,_47.parent,_47.property);_4c=_48;while(_4d.length>1){_4c=_4c[_4d.pop()];}_4c[_4d]=val;_4b.setValue(_47.parent,_47.property,_48);}}}catch(e){alert(e);}};if(_4a.validate()){_46=this.lastFocused;_47=_46.item;var _4f=_47.value;if(_47.addNew){_4f=_46.item.parent;_46=_46.getParent();_47=_46.item;}val=null;switch(_45.itemType){case "reference":this.store.fetchItemByIdentity({identity:_45._reference,onItem:function $DoE_(_51){val=_51;setValue();},onError:function $DoF_(){alert("The id could not be found");}});break;case "value":var _52=_45.jsonVal;val=dojo.fromJson(_52);if(typeof val=="function"){val.toString=function $DoK_(){return _52;};}setValue();break;}}else{_4a.show();}},_editProperty:function $DoG_(){var _53=dojo.mixin({},this.lastFocused.item);if(!this._editDialog){this._createEditDialog();}else{this._editDialog.reset();}if(dojo.indexOf(this.store.getIdentityAttributes(),_53.property)>=0){alert("Cannot Edit an Identifier!");}else{this._editDialog.attr("title","Edit Property");dijit.getEnclosingWidget(dojo.query("input",this._editDialog.containerNode)[0]).attr("disabled",true);if(this.store.isItem(_53.value,true)){if(_53.parent){_53.itemType="reference";this._enableFields(_53.itemType);_53._reference=this.store.getIdentity(_53.value);this._editDialog.attr("value",_53);this._editDialog.show();}}else{if(_53.value&&typeof _53.value=="object"&&!(_53.value instanceof Date)){}else{_53.itemType="value";this._enableFields(_53.itemType);_53.jsonVal=typeof _53.value=="function"?_53.value.toString():_53.value instanceof Date?"new Date(\""+_53.value+"\")":dojo.toJson(_53.value);this._editDialog.attr("value",_53);this._editDialog.show();}}}},_destroyProperty:function $DoH_(){var _54=this.lastFocused;var _55=_54.item;var _56=[];while(!this.store.isItem(_55.parent,true)||_55.parent instanceof Array){_54=_54.getParent();_56.push(_55.property);_55=_54.item;}if(dojo.indexOf(this.store.getIdentityAttributes(),_55.property)>=0){alert("Cannot Delete an Identifier!");}else{try{if(_56.length>0){var _57,_58=_1(this.store,_55.parent,_55.property);_57=_58;while(_56.length>1){_57=_57[_56.pop()];}if(dojo.isArray(_57)){_57.splice(_56,1);}else{delete _57[_56];}this.store.setValue(_55.parent,_55.property,_58);}else{this.store.unsetAttribute(_55.parent,_55.property);}}catch(e){alert(e);}}},_addProperty:function $DoI_(){var _59=this.lastFocused.item;var _5a=_59.value;var _5b=dojo.hitch(this,function(){var _5c=null;if(!this._editDialog){this._createEditDialog();}else{this._editDialog.reset();}if(_5a instanceof Array){_5c=_5a.length;dijit.getEnclosingWidget(dojo.query("input",this._editDialog.containerNode)[0]).attr("disabled",true);}else{dijit.getEnclosingWidget(dojo.query("input",this._editDialog.containerNode)[0]).attr("disabled",false);}this._editDialog.attr("title","Add Property");this._enableFields("value");this._editDialog.attr("value",{itemType:"value",property:_5c});this._editDialog.show();});if(_59.addNew){_59=this.lastFocused.getParent().item;_5a=this.lastFocused.item.parent;}if(_59.property&&dojo.indexOf(this.store.getIdentityAttributes(),_59.property)>=0){alert("Cannot add properties to an ID node!");}else{if(this.store.isItem(_5a,true)&&!this.store.isItemLoaded(_5a)){this.store.loadItem({item:_5a,onItem:function $DoJ_(_5d){_5a=_5d;_5b();}});}else{_5b();}}}});})();}