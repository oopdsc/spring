/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.data.CssRuleStore"]){dojo._hasResource["dojox.data.CssRuleStore"]=true;dojo.provide("dojox.data.CssRuleStore");dojo.require("dojo.data.util.filter");dojo.require("dojo.data.util.sorter");dojo.require("dojox.data.css");dojo.declare("dojox.data.CssRuleStore",null,{_storeRef:"_S",_labelAttribute:"selector",_cache:null,_browserMap:null,_cName:"dojox.data.CssRuleStore",constructor:function $DlB_(_1){if(_1){dojo.mixin(this,_1);}this._cache={};this._allItems=null;this._waiting=[];this.gatherHandle=null;var _2=this;function gatherRules(){try{_2.context=dojox.data.css.determineContext(_2.context);if(_2.gatherHandle){clearInterval(_2.gatherHandle);_2.gatherHandle=null;}while(_2._waiting.length){var _3=_2._waiting.pop();dojox.data.css.rules.forEach(_3.forFunc,null,_2.context);_3.finishFunc();}}catch(e){}};this.gatherHandle=setInterval(gatherRules,250);},setContext:function $DlC_(_4){if(_4){this.close();this.context=dojox.data.css.determineContext(_4);}},getFeatures:function $DlD_(){return {"dojo.data.api.Read":true};},isItem:function $DlE_(_5){if(_5&&_5[this._storeRef]==this){return true;}return false;},hasAttribute:function $DlF_(_6,_7){this._assertIsItem(_6);this._assertIsAttribute(_7);var _8=this.getAttributes(_6);if(dojo.indexOf(_8,_7)!=-1){return true;}return false;},getAttributes:function $DlG_(_9){this._assertIsItem(_9);var _a=["selector","classes","rule","style","cssText","styleSheet","parentStyleSheet","parentStyleSheetHref"];var _b=_9.rule.style;if(_b){var _c;for(_c in _b){_a.push("style."+_c);}}return _a;},getValue:function $DlH_(_d,_e,_f){var _10=this.getValues(_d,_e);var _11=_f;if(_10&&_10.length>0){return _10[0];}return _f;},getValues:function $DlI_(_12,_13){this._assertIsItem(_12);this._assertIsAttribute(_13);var _14=null;if(_13==="selector"){_14=_12.rule["selectorText"];if(_14&&dojo.isString(_14)){_14=_14.split(",");}}else{if(_13==="classes"){_14=_12.classes;}else{if(_13==="rule"){_14=_12.rule.rule;}else{if(_13==="style"){_14=_12.rule.style;}else{if(_13==="cssText"){if(dojo.isIE){if(_12.rule.style){_14=_12.rule.style.cssText;if(_14){_14="{ "+_14.toLowerCase()+" }";}}}else{_14=_12.rule.cssText;if(_14){_14=_14.substring(_14.indexOf("{"),_14.length);}}}else{if(_13==="styleSheet"){_14=_12.rule.styleSheet;}else{if(_13==="parentStyleSheet"){_14=_12.rule.parentStyleSheet;}else{if(_13==="parentStyleSheetHref"){if(_12.href){_14=_12.href;}}else{if(_13.indexOf("style.")===0){var _15=_13.substring(_13.indexOf("."),_13.length);_14=_12.rule.style[_15];}else{_14=[];}}}}}}}}}if(_14!==undefined){if(!dojo.isArray(_14)){_14=[_14];}}return _14;},getLabel:function $DlJ_(_16){this._assertIsItem(_16);return this.getValue(_16,this._labelAttribute);},getLabelAttributes:function $DlK_(_17){return [this._labelAttribute];},containsValue:function $DlL_(_18,_19,_1a){var _1b=undefined;if(typeof _1a==="string"){_1b=dojo.data.util.filter.patternToRegExp(_1a,false);}return this._containsValue(_18,_19,_1a,_1b);},isItemLoaded:function $DlM_(_1c){return this.isItem(_1c);},loadItem:function $DlN_(_1d){this._assertIsItem(_1d.item);},fetch:function $DlO_(_1e){_1e=_1e||{};if(!_1e.store){_1e.store=this;}var _1f=_1e.scope||dojo.global;if(this._pending&&this._pending.length>0){this._pending.push({request:_1e,fetch:true});}else{this._pending=[{request:_1e,fetch:true}];this._fetch(_1e);}return _1e;},_fetch:function $DlP_(_20){var _21=_20.scope||dojo.global;if(this._allItems===null){this._allItems={};try{if(this.gatherHandle){this._waiting.push({"forFunc":dojo.hitch(this,this._handleRule),"finishFunc":dojo.hitch(this,this._handleReturn)});}else{dojox.data.css.rules.forEach(dojo.hitch(this,this._handleRule),null,this.context);this._handleReturn();}}catch(e){if(_20.onError){_20.onError.call(_21,e,_20);}}}else{this._handleReturn();}},_handleRule:function $DlQ_(_22,_23,_24){var _25=_22["selectorText"];var s=_25.split(" ");var _26=[];for(var j=0;j<s.length;j++){var tmp=s[j];var _27=tmp.indexOf(".");if(tmp&&tmp.length>0&&_27!==-1){var _28=tmp.indexOf(",")||tmp.indexOf("[");tmp=tmp.substring(_27,((_28!==-1&&_28>_27)?_28:tmp.length));_26.push(tmp);}}var _29={};_29.rule=_22;_29.styleSheet=_23;_29.href=_24;_29.classes=_26;_29[this._storeRef]=this;if(!this._allItems[_25]){this._allItems[_25]=[];}this._allItems[_25].push(_29);},_handleReturn:function $DlR_(){var _2a=[];var _2b=[];var _2c=null;for(var i in this._allItems){_2c=this._allItems[i];for(var j in _2c){_2b.push(_2c[j]);}}var _2d;while(this._pending.length){_2d=this._pending.pop();_2d.request._items=_2b;_2a.push(_2d);}while(_2a.length){_2d=_2a.pop();this._handleFetchReturn(_2d.request);}},_handleFetchReturn:function $DlS_(_2e){var _2f=_2e.scope||dojo.global;var _30=[];var _31="all";var i;if(_2e.query){_31=dojo.toJson(_2e.query);}if(this._cache[_31]){_30=this._cache[_31];}else{if(_2e.query){for(i in _2e._items){var _32=_2e._items[i];var _33=dojo.isWebKit?true:(_2e.queryOptions?_2e.queryOptions.ignoreCase:false);var _34={};var key;var _35;for(key in _2e.query){_35=_2e.query[key];if(typeof _35==="string"){_34[key]=dojo.data.util.filter.patternToRegExp(_35,_33);}}var _36=true;for(key in _2e.query){_35=_2e.query[key];if(!this._containsValue(_32,key,_35,_34[key])){_36=false;}}if(_36){_30.push(_32);}}this._cache[_31]=_30;}else{for(i in _2e._items){_30.push(_2e._items[i]);}}}var _37=_30.length;if(_2e.sort){_30.sort(dojo.data.util.sorter.createSortFunction(_2e.sort,this));}var _38=0;var _39=_30.length;if(_2e.start>0&&_2e.start<_30.length){_38=_2e.start;}if(_2e.count&&_2e.count){_39=_2e.count;}var _3a=_38+_39;if(_3a>_30.length){_3a=_30.length;}_30=_30.slice(_38,_3a);if(_2e.onBegin){_2e.onBegin.call(_2f,_37,_2e);}if(_2e.onItem){if(dojo.isArray(_30)){for(i=0;i<_30.length;i++){_2e.onItem.call(_2f,_30[i],_2e);}if(_2e.onComplete){_2e.onComplete.call(_2f,null,_2e);}}}else{if(_2e.onComplete){_2e.onComplete.call(_2f,_30,_2e);}}return _2e;},close:function $DlT_(){this._cache={};this._allItems=null;},_assertIsItem:function $DlU_(_3b){if(!this.isItem(_3b)){throw new Error(this._cName+": Invalid item argument.");}},_assertIsAttribute:function $DlV_(_3c){if(typeof _3c!=="string"){throw new Error(this._cName+": Invalid attribute argument.");}},_containsValue:function $DlW_(_3d,_3e,_3f,_40){return dojo.some(this.getValues(_3d,_3e),function(_41){if(_41!==null&&!dojo.isObject(_41)&&_40){if(_41.toString().match(_40)){return true;}}else{if(_3f===_41){return true;}}return false;});}});}