/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.rpc.JsonRest"]){dojo._hasResource["dojox.rpc.JsonRest"]=true;dojo.provide("dojox.rpc.JsonRest");dojo.require("dojox.json.ref");dojo.require("dojox.rpc.Rest");(function(){var _1=[];var _2=dojox.rpc.Rest;var jr;function resolveJson(_3,_4,_5,_6){var _7=_4.ioArgs&&_4.ioArgs.xhr&&_4.ioArgs.xhr.getResponseHeader("Last-Modified");if(_7&&_2._timeStamps){_2._timeStamps[_6]=_7;}var _8=_3._schema&&_3._schema.hrefProperty;if(_8){dojox.json.ref.refAttribute=_8;}_5=_5&&dojox.json.ref.resolveJson(_5,{defaultId:_6,index:_2._index,timeStamps:_7&&_2._timeStamps,time:_7,idPrefix:_3.servicePath.replace(/[^\/]*$/,""),idAttribute:jr.getIdAttribute(_3),schemas:jr.schemas,loader:jr._loader,idAsRef:_3.idAsRef,assignAbsoluteIds:true});dojox.json.ref.refAttribute="$ref";return _5;};jr=dojox.rpc.JsonRest={serviceClass:dojox.rpc.Rest,conflictDateHeader:"If-Unmodified-Since",commit:function $DAqG_(_9){_9=_9||{};var _a=[];var _b={};var _c=[];for(var i=0;i<_1.length;i++){var _d=_1[i];var _e=_d.object;var _f=_d.old;var _10=false;if(!(_9.service&&(_e||_f)&&(_e||_f).__id.indexOf(_9.service.servicePath))&&_d.save){delete _e.__isDirty;if(_e){if(_f){var _11;if((_11=_e.__id.match(/(.*)#.*/))){_e=_2._index[_11[1]];}if(!(_e.__id in _b)){_b[_e.__id]=_e;if(_9.incrementalUpdates&&!_11){var _12=(typeof _9.incrementalUpdates=="function"?_9.incrementalUpdates:function(){_12={};for(var j in _e){if(_e.hasOwnProperty(j)){if(_e[j]!==_f[j]){_12[j]=_e[j];}}else{if(_f.hasOwnProperty(j)){return null;}}}return _12;})(_e,_f);}if(_12){_a.push({method:"post",target:_e,content:_12});}else{_a.push({method:"put",target:_e,content:_e});}}}else{var _13=jr.getServiceAndId(_e.__id).service;var _14=jr.getIdAttribute(_13);if((_14 in _e)&&!_9.alwaysPostNewItems){_a.push({method:"put",target:_e,content:_e});}else{_a.push({method:"post",target:{__id:_13.servicePath},content:_e});}}}else{if(_f){_a.push({method:"delete",target:_f});}}_c.push(_d);_1.splice(i--,1);}}dojo.connect(_9,"onError",function(){if(_9.revertOnError!==false){var _15=_1;_1=_c;var _16=0;jr.revert();_1=_15;}else{_1=dirtyObject.concat(_c);}});jr.sendToServer(_a,_9);return _a;},sendToServer:function $DAqH_(_17,_18){var _19;var _1a=dojo.xhr;var _1b=_17.length;var i,_1c;var _1d;var _1e=this.conflictDateHeader;dojo.xhr=function $DAqV_(_1f,_20){_20.headers=_20.headers||{};_20.headers["Transaction"]=_17.length-1==i?"commit":"open";if(_1e&&_1d){_20.headers[_1e]=_1d;}if(_1c){_20.headers["Content-ID"]="<"+_1c+">";}return _1a.apply(dojo,arguments);};for(i=0;i<_17.length;i++){var _21=_17[i];dojox.rpc.JsonRest._contentId=_21.content&&_21.content.__id;var _22=_21.method=="post";_1d=_21.method=="put"&&_2._timeStamps[_21.content.__id];if(_1d){_2._timeStamps[_21.content.__id]=(new Date())+"";}_1c=_22&&dojox.rpc.JsonRest._contentId;var _23=jr.getServiceAndId(_21.target.__id);var _24=_23.service;var dfd=_21.deferred=_24[_21.method](_23.id.replace(/#/,""),dojox.json.ref.toJson(_21.content,false,_24.servicePath,true));(function(_25,dfd,_26){dfd.addCallback(function(_27){try{var _28=dfd.ioArgs.xhr&&dfd.ioArgs.xhr.getResponseHeader("Location");if(_28){var _29=_28.match(/(^\w+:\/\/)/)&&_28.indexOf(_26.servicePath);_28=_29>0?_28.substring(_29):(_26.servicePath+_28).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3");_25.__id=_28;_2._index[_28]=_25;}_27=resolveJson(_26,dfd,_27,_25&&_25.__id);}catch(e){}if(!(--_1b)){if(_18.onComplete){_18.onComplete.call(_18.scope,_17);}}return _27;});})(_21.content,dfd,_24);dfd.addErrback(function(_2a){_1b=-1;_18.onError.call(_18.scope,_2a);});}dojo.xhr=_1a;},getDirtyObjects:function $DAqI_(){return _1;},revert:function $DAqJ_(_2b){for(var i=_1.length;i>0;){i--;var _2c=_1[i];var _2d=_2c.object;var old=_2c.old;var _2e=dojox.data._getStoreForItem(_2d||old);if(!(_2b&&(_2d||old)&&(_2d||old).__id.indexOf(_2b.servicePath))){if(_2d&&old){for(var j in old){if(old.hasOwnProperty(j)&&_2d[j]!==old[j]){if(_2e){_2e.onSet(_2d,j,_2d[j],old[j]);}_2d[j]=old[j];}}for(j in _2d){if(!old.hasOwnProperty(j)){if(_2e){_2e.onSet(_2d,j,_2d[j]);}delete _2d[j];}}}else{if(!old){if(_2e){_2e.onDelete(_2d);}}else{if(_2e){_2e.onNew(old);}}}delete (_2d||old).__isDirty;_1.splice(i,1);}}},changing:function $DAqK_(_2f,_30){if(!_2f.__id){return;}_2f.__isDirty=true;for(var i=0;i<_1.length;i++){var _31=_1[i];if(_2f==_31.object){if(_30){_31.object=false;if(!this._saveNotNeeded){_31.save=true;}}return;}}var old=_2f instanceof Array?[]:{};for(i in _2f){if(_2f.hasOwnProperty(i)){old[i]=_2f[i];}}_1.push({object:!_30&&_2f,old:old,save:!this._saveNotNeeded});},deleteObject:function $DAqL_(_32){this.changing(_32,true);},getConstructor:function $DAqM_(_33,_34){if(typeof _33=="string"){var _35=_33;_33=new dojox.rpc.Rest(_33,true);this.registerService(_33,_35,_34);}if(_33._constructor){return _33._constructor;}_33._constructor=function $DAqW_(_36){var _37=this;var _38=arguments;var _39;var _3a;function addDefaults(_3b){if(_3b){addDefaults(_3b["extends"]);_39=_3b.properties;for(var i in _39){var _3c=_39[i];if(_3c&&(typeof _3c=="object")&&("default" in _3c)){_37[i]=_3c["default"];}}}if(_3b&&_3b.prototype&&_3b.prototype.initialize){_3a=true;_3b.prototype.initialize.apply(_37,_38);}};addDefaults(_33._schema);if(!_3a&&_36&&typeof _36=="object"){dojo.mixin(_37,_36);}var _3d=jr.getIdAttribute(_33);_2._index[this.__id=this.__clientId=_33.servicePath+(this[_3d]||Math.random().toString(16).substring(2,14)+"@"+((dojox.rpc.Client&&dojox.rpc.Client.clientId)||"client"))]=this;if(dojox.json.schema&&_39){dojox.json.schema.mustBeValid(dojox.json.schema.validate(this,_33._schema));}_1.push({object:this,save:true});};return dojo.mixin(_33._constructor,_33._schema,{load:_33});},fetch:function $DAqN_(_3e){var _3f=jr.getServiceAndId(_3e);return this.byId(_3f.service,_3f.id);},getIdAttribute:function $DAqO_(_40){var _41=_40._schema;var _42;if(_41){if(!(_42=_41._idAttr)){for(var i in _41.properties){if(_41.properties[i].identity||(_41.properties[i].link=="self")){_41._idAttr=_42=i;}}}}return _42||"id";},getServiceAndId:function $DAqP_(_43){var _44="";for(var _45 in jr.services){if((_43.substring(0,_45.length)==_45)&&(_45.length>=_44.length)){_44=_45;}}if(_44){return {service:jr.services[_44],id:_43.substring(_44.length)};}var _46=_43.match(/^(.*\/)([^\/]*)$/);return {service:new jr.serviceClass(_46[1],true),id:_46[2]};},services:{},schemas:{},registerService:function $DAqQ_(_47,_48,_49){_48=_47.servicePath=_48||_47.servicePath;_47._schema=jr.schemas[_48]=_49||_47._schema||{};jr.services[_48]=_47;},byId:function $DAqR_(_4a,id){var _4b,_4c=_2._index[(_4a.servicePath||"")+id];if(_4c&&!_4c._loadObject){_4b=new dojo.Deferred();_4b.callback(_4c);return _4b;}return this.query(_4a,id);},query:function $DAqS_(_4d,id,_4e){var _4f=_4d(id,_4e);_4f.addCallback(function(_50){if(_50.nodeType&&_50.cloneNode){return _50;}return resolveJson(_4d,_4f,_50,typeof id!="string"||(_4e&&(_4e.start||_4e.count))?undefined:id);});return _4f;},_loader:function $DAqT_(_51){var _52=jr.getServiceAndId(this.__id);var _53=this;jr.query(_52.service,_52.id).addBoth(function(_54){if(_54==_53){delete _54.$ref;delete _54._loadObject;}else{_53._loadObject=function $DAqX_(_55){_55(_54);};}_51(_54);});},isDirty:function $DAqU_(_56){if(!_56){return !!_1.length;}return _56.__isDirty;}};})();}