/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.rpc.OfflineRest"]){dojo._hasResource["dojox.rpc.OfflineRest"]=true;dojo.provide("dojox.rpc.OfflineRest");dojo.require("dojox.data.ClientFilter");dojo.require("dojox.rpc.Rest");dojo.require("dojox.storage");(function(){var _1=dojox.rpc.Rest;var _2="dojox_rpc_OfflineRest";var _3;var _4=_1._index;dojox.storage.manager.addOnLoad(function(){_3=dojox.storage.manager.available;for(var i in _4){saveObject(_4[i],i);}});var _5;function getStorageKey(_6){return _6.replace(/[^0-9A-Za-z_]/g,"_");};function saveObject(_7,id){if(_3&&!_5&&(id||(_7&&_7.__id))){dojox.storage.put(getStorageKey(id||_7.__id),typeof _7=="object"?dojox.json.ref.toJson(_7):_7,function(){},_2);}};function isNetworkError(_8){return _8 instanceof Error&&(_8.status==503||_8.status>12000||!_8.status);};function sendChanges(){if(_3){var _9=dojox.storage.get("dirty",_2);if(_9){for(var _a in _9){commitDirty(_a,_9);}}}};var _b;function sync(){_b.sendChanges();_b.downloadChanges();};var _c=setInterval(sync,15000);dojo.connect(document,"ononline",sync);_b=dojox.rpc.OfflineRest={turnOffAutoSync:function $DAqa_(){clearInterval(_c);},sync:sync,sendChanges:sendChanges,downloadChanges:function $DAqb_(){},addStore:function $DAqc_(_d,_e){_b.stores.push(_d);_d.fetch({queryOptions:{cache:true},query:_e,onComplete:function(_f,_10){_d._localBaseResults=_f;_d._localBaseFetch=_10;}});}};_b.stores=[];var _11=_1._get;_1._get=function $DAqd_(_12,id){try{sendChanges();if(window.navigator&&navigator.onLine===false){throw new Error();}var dfd=_11(_12,id);}catch(e){dfd=new dojo.Deferred();dfd.errback(e);}var _13=dojox.rpc._sync;dfd.addCallback(function(_14){saveObject(_14,_12._getRequest(id).url);return _14;});dfd.addErrback(function(_15){if(_3){if(isNetworkError(_15)){var _16={};var _17=function(id,_18){if(_16[id]){return _18;}var _19=dojo.fromJson(dojox.storage.get(getStorageKey(id),_2))||_18;_16[id]=_19;for(var i in _19){var val=_19[i];id=val&&val.$ref;if(id){if(id.substring&&id.substring(0,4)=="cid:"){id=id.substring(4);}_19[i]=_17(id,val);}}if(_19 instanceof Array){for(i=0;i<_19.length;i++){if(_19[i]===undefined){_19.splice(i--,1);}}}return _19;};_5=true;var _1a=_17(_12._getRequest(id).url);if(!_1a){return _15;}_5=false;return _1a;}else{return _15;}}else{if(_13){return new Error("Storage manager not loaded, can not continue");}dfd=new dojo.Deferred();dfd.addCallback(arguments.callee);dojox.storage.manager.addOnLoad(function(){dfd.callback();});return dfd;}});return dfd;};function changeOccurred(_1b,_1c,_1d,_1e,_1f){if(_1b=="delete"){dojox.storage.remove(getStorageKey(_1c),_2);}else{dojox.storage.put(getStorageKey(_1d),_1e,function(){},_2);}var _20=_1f&&_1f._store;if(_20){_20.updateResultSet(_20._localBaseResults,_20._localBaseFetch);dojox.storage.put(getStorageKey(_1f._getRequest(_20._localBaseFetch.query).url),dojox.json.ref.toJson(_20._localBaseResults),function(){},_2);}};dojo.addOnLoad(function(){dojo.connect(dojox.data,"restListener",function(_21){var _22=_21.channel;var _23=_21.event.toLowerCase();var _24=dojox.rpc.JsonRest&&dojox.rpc.JsonRest.getServiceAndId(_22).service;changeOccurred(_23,_22,_23=="post"?_22+_21.result.id:_22,dojo.toJson(_21.result),_24);});});var _25=_1._change;_1._change=function $DAqe_(_26,_27,id,_28){if(!_3){return _25.apply(this,arguments);}var _29=_27._getRequest(id).url;changeOccurred(_26,_29,dojox.rpc.JsonRest._contentId,_28,_27);var _2a=dojox.storage.get("dirty",_2)||{};if(_26=="put"||_26=="delete"){var _2b=_29;}else{_2b=0;for(var i in _2a){if(!isNaN(parseInt(i))){_2b=i;}}_2b++;}_2a[_2b]={method:_26,id:_29,content:_28};return commitDirty(_2b,_2a);};function commitDirty(_2c,_2d){var _2e=_2d[_2c];var _2f=dojox.rpc.JsonRest.getServiceAndId(_2e.id);var _30=_25(_2e.method,_2f.service,_2f.id,_2e.content);_2d[_2c]=_2e;dojox.storage.put("dirty",_2d,function(){},_2);_30.addBoth(function(_31){if(isNetworkError(_31)){return null;}var _32=dojox.storage.get("dirty",_2)||{};delete _32[_2c];dojox.storage.put("dirty",_32,function(){},_2);return _31;});return _30;};dojo.connect(_4,"onLoad",saveObject);dojo.connect(_4,"onUpdate",saveObject);})();}