/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.rpc.Service"]){dojo._hasResource["dojox.rpc.Service"]=true;dojo.provide("dojox.rpc.Service");dojo.require("dojo.AdapterRegistry");dojo.declare("dojox.rpc.Service",null,{constructor:function $DAql_(_1,_2){var _3;var _4=this;function processSmd(_5){_5._baseUrl=new dojo._Url((dojo.isBrowser?location.href:dojo.config.baseUrl),_3||".")+"";_4._smd=_5;for(var _6 in _4._smd.services){var _7=_6.split(".");var _8=_4;for(var i=0;i<_7.length-1;i++){_8=_8[_7[i]]||(_8[_7[i]]={});}_8[_7[_7.length-1]]=_4._generateService(_6,_4._smd.services[_6]);}};if(_1){if((dojo.isString(_1))||(_1 instanceof dojo._Url)){if(_1 instanceof dojo._Url){_3=_1+"";}else{_3=_1;}var _9=dojo._getText(_3);if(!_9){throw new Error("Unable to load SMD from "+_1);}else{processSmd(dojo.fromJson(_9));}}else{processSmd(_1);}}this._options=(_2?_2:{});this._requestId=0;},_generateService:function $DAqm_(_a,_b){if(this[_b]){throw new Error("WARNING: "+_a+" already exists for service. Unable to generate function");}_b.name=_a;var _c=dojo.hitch(this,"_executeMethod",_b);var _d=dojox.rpc.transportRegistry.match(_b.transport||this._smd.transport);if(_d.getExecutor){_c=_d.getExecutor(_c,_b,this);}var _e=_b.returns||(_b._schema={});var _f="/"+_a+"/";_e._service=_c;_c.servicePath=_f;_c._schema=_e;_c.id=dojox.rpc.Service._nextId++;return _c;},_getRequest:function $DAqn_(_10,_11){var smd=this._smd;var _12=dojox.rpc.envelopeRegistry.match(_10.envelope||smd.envelope||"NONE");var _13=(_10.parameters||[]).concat(smd.parameters||[]);if(_12.namedParams){if((_11.length==1)&&dojo.isObject(_11[0])){_11=_11[0];}else{var _14={};for(var i=0;i<_10.parameters.length;i++){if(typeof _11[i]!="undefined"||!_10.parameters[i].optional){_14[_10.parameters[i].name]=_11[i];}}_11=_14;}if(_10.strictParameters||smd.strictParameters){for(i in _11){var _15=false;for(var j=0;j<_13.length;j++){if(_13[i].name==i){_15=true;}}if(!_15){delete _11[i];}}}for(i=0;i<_13.length;i++){var _16=_13[i];if(!_16.optional&&_16.name&&!_11[_16.name]){if(_16["default"]){_11[_16.name]=_16["default"];}else{if(!(_16.name in _11)){throw new Error("Required parameter "+_16.name+" was omitted");}}}}}else{if(_13&&_13[0]&&_13[0].name&&(_11.length==1)&&dojo.isObject(_11[0])){if(_12.namedParams===false){_11=dojox.rpc.toOrdered(_13,_11);}else{_11=_11[0];}}}if(dojo.isObject(this._options)){_11=dojo.mixin(_11,this._options);}var _17=_10._schema||_10.returns;var _18=_12.serialize.apply(this,[smd,_10,_11]);_18._envDef=_12;var _19=(_10.contentType||smd.contentType||_18.contentType);return dojo.mixin(_18,{sync:dojox.rpc._sync,contentType:_19,headers:{},target:_18.target||dojox.rpc.getTarget(smd,_10),transport:_10.transport||smd.transport||_18.transport,envelope:_10.envelope||smd.envelope||_18.envelope,timeout:_10.timeout||smd.timeout,callbackParamName:_10.callbackParamName||smd.callbackParamName,schema:_17,handleAs:_18.handleAs||"auto",preventCache:_10.preventCache||smd.preventCache,frameDoc:this._options.frameDoc||undefined});},_executeMethod:function $DAqo_(_1a){var _1b=[];var i;for(i=1;i<arguments.length;i++){_1b.push(arguments[i]);}var _1c=this._getRequest(_1a,_1b);var _1d=dojox.rpc.transportRegistry.match(_1c.transport).fire(_1c);_1d.addBoth(function(_1e){return _1c._envDef.deserialize.call(this,_1e);});return _1d;}});dojox.rpc.getTarget=function $DAqy_(smd,_1f){var _20=smd._baseUrl;if(smd.target){_20=new dojo._Url(_20,smd.target)+"";}if(_1f.target){_20=new dojo._Url(_20,_1f.target)+"";}return _20;};dojox.rpc.toOrdered=function $DAqz_(_21,_22){if(dojo.isArray(_22)){return _22;}var _23=[];for(var i=0;i<_21.length;i++){_23.push(_22[_21[i].name]);}return _23;};dojox.rpc.transportRegistry=new dojo.AdapterRegistry(true);dojox.rpc.envelopeRegistry=new dojo.AdapterRegistry(true);dojox.rpc.envelopeRegistry.register("URL",function(str){return str=="URL";},{serialize:function $DAqp_(smd,_24,_25){var d=dojo.objectToQuery(_25);return {data:d,transport:"POST"};},deserialize:function $DAqq_(_26){return _26;},namedParams:true});dojox.rpc.envelopeRegistry.register("JSON",function(str){return str=="JSON";},{serialize:function $DAqr_(smd,_27,_28){var d=dojo.toJson(_28);return {data:d,handleAs:"json",contentType:"application/json"};},deserialize:function $DAqs_(_29){return _29;}});dojox.rpc.envelopeRegistry.register("PATH",function(str){return str=="PATH";},{serialize:function $DAqt_(smd,_2a,_2b){var i;var _2c=dojox.rpc.getTarget(smd,_2a);if(dojo.isArray(_2b)){for(i=0;i<_2b.length;i++){_2c+="/"+_2b[i];}}else{for(i in _2b){_2c+="/"+i+"/"+_2b[i];}}return {data:"",target:_2c};},deserialize:function $DAqu_(_2d){return _2d;}});dojox.rpc.transportRegistry.register("POST",function(str){return str=="POST";},{fire:function $DAqv_(r){r.url=r.target;r.postData=r.data;return dojo.rawXhrPost(r);}});dojox.rpc.transportRegistry.register("GET",function(str){return str=="GET";},{fire:function $DAqw_(r){r.url=r.target+(r.data?"?"+r.data:"");return dojo.xhrGet(r);}});dojox.rpc.transportRegistry.register("JSONP",function(str){return str=="JSONP";},{fire:function $DAqx_(r){r.url=r.target+((r.target.indexOf("?")==-1)?"?":"&")+r.data;r.callbackParamName=r.callbackParamName||"callback";return dojo.io.script.get(r);}});dojox.rpc.Service._nextId=1;dojo._contentHandlers.auto=function $DAq0_(xhr){var _2e=dojo._contentHandlers;var _2f=xhr.getResponseHeader("Content-Type");var _30=!_2f?_2e.text(xhr):_2f.match(/\/.*json/)?_2e.json(xhr):_2f.match(/\/javascript/)?_2e.javascript(xhr):_2f.match(/\/xml/)?_2e.xml(xhr):_2e.text(xhr);return _30;};}