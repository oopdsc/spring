/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojo._base.xhr"]){dojo._hasResource["dojo._base.xhr"]=true;dojo.provide("dojo._base.xhr");dojo.require("dojo._base.Deferred");dojo.require("dojo._base.json");dojo.require("dojo._base.lang");dojo.require("dojo._base.query");(function(){var _1=dojo,_2=_1.config;function setValue(_3,_4,_5){if(_5===null){return;}var _6=_3[_4];if(typeof _6=="string"){_3[_4]=[_6,_5];}else{if(_1.isArray(_6)){_6.push(_5);}else{_3[_4]=_5;}}};dojo.fieldToObject=function $DBOS_(_7){var _8=null;var _9=_1.byId(_7);if(_9){var _a=_9.name;var _b=(_9.type||"").toLowerCase();if(_a&&_b&&!_9.disabled){if(_b=="radio"||_b=="checkbox"){if(_9.checked){_8=_9.value;}}else{if(_9.multiple){_8=[];_1.query("option",_9).forEach(function(_c){if(_c.selected){_8.push(_c.value);}});}else{_8=_9.value;}}}}return _8;};dojo.formToObject=function $DBOT_(_d){var _e={};var _f="file|submit|image|reset|button|";_1.forEach(dojo.byId(_d).elements,function(_10){var _11=_10.name;var _12=(_10.type||"").toLowerCase();if(_11&&_12&&_f.indexOf(_12)==-1&&!_10.disabled){setValue(_e,_11,_1.fieldToObject(_10));if(_12=="image"){_e[_11+".x"]=_e[_11+".y"]=_e[_11].x=_e[_11].y=0;}}});return _e;};dojo.objectToQuery=function $DBOU_(map){var enc=encodeURIComponent;var _13=[];var _14={};for(var _15 in map){var _16=map[_15];if(_16!=_14[_15]){var _17=enc(_15)+"=";if(_1.isArray(_16)){for(var i=0;i<_16.length;i++){_13.push(_17+enc(_16[i]));}}else{_13.push(_17+enc(_16));}}}return _13.join("&");};dojo.formToQuery=function $DBOV_(_18){return _1.objectToQuery(_1.formToObject(_18));};dojo.formToJson=function $DBOW_(_19,_1a){return _1.toJson(_1.formToObject(_19),_1a);};dojo.queryToObject=function $DBOX_(str){var ret={};var qp=str.split("&");var dec=decodeURIComponent;_1.forEach(qp,function(_1b){if(_1b.length){var _1c=_1b.split("=");var _1d=dec(_1c.shift());var val=dec(_1c.join("="));if(typeof ret[_1d]=="string"){ret[_1d]=[ret[_1d]];}if(_1.isArray(ret[_1d])){ret[_1d].push(val);}else{ret[_1d]=val;}}});return ret;};dojo._blockAsync=false;var _1e=_1._contentHandlers=dojo.contentHandlers={text:function $DBOK_(xhr){return xhr.responseText;},json:function $DBOL_(xhr){return _1.fromJson(xhr.responseText||null);},"json-comment-filtered":function(xhr){if(!dojo.config.useCommentedJson){console.warn("Consider using the standard mimetype:application/json."+" json-commenting can introduce security issues. To"+" decrease the chances of hijacking, use the standard the 'json' handler and"+" prefix your json with: {}&&\n"+"Use djConfig.useCommentedJson=true to turn off this message.");}var _1f=xhr.responseText;var _20=_1f.indexOf("/*");var _21=_1f.lastIndexOf("*/");if(_20==-1||_21==-1){throw new Error("JSON was not comment filtered");}return _1.fromJson(_1f.substring(_20+2,_21));},javascript:function $DBOM_(xhr){return _1.eval(xhr.responseText);},xml:function $DBON_(xhr){var _22=xhr.responseXML;if(_1.isIE&&(!_22||!_22.documentElement)){var ms=function(n){return "MSXML"+n+".DOMDocument";};var dp=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)];_1.some(dp,function(p){try{var dom=new ActiveXObject(p);dom.async=false;dom.loadXML(xhr.responseText);_22=dom;}catch(e){return false;}return true;});}return _22;},"json-comment-optional":function(xhr){if(xhr.responseText&&/^[^{\[]*\/\*/.test(xhr.responseText)){return _1e["json-comment-filtered"](xhr);}else{return _1e["json"](xhr);}}};dojo._ioSetArgs=function $DBOb_(_23,_24,_25,_26){var _27={args:_23,url:_23.url};var _28=null;if(_23.form){var _29=_1.byId(_23.form);var _2a=_29.getAttributeNode("action");_27.url=_27.url||(_2a?_2a.value:null);_28=_1.formToObject(_29);}var _2b=[{}];if(_28){_2b.push(_28);}if(_23.content){_2b.push(_23.content);}if(_23.preventCache){_2b.push({"dojo.preventCache":new Date().valueOf()});}_27.query=_1.objectToQuery(_1.mixin.apply(null,_2b));_27.handleAs=_23.handleAs||"text";var d=new _1.Deferred(_24);d.addCallbacks(_25,function(_2c){return _26(_2c,d);});var ld=_23.load;if(ld&&_1.isFunction(ld)){d.addCallback(function(_2d){return ld.call(_23,_2d,_27);});}var err=_23.error;if(err&&_1.isFunction(err)){d.addErrback(function(_2e){return err.call(_23,_2e,_27);});}var _2f=_23.handle;if(_2f&&_1.isFunction(_2f)){d.addBoth(function(_30){return _2f.call(_23,_30,_27);});}if(_2.ioPublish&&_1.publish&&_27.args.ioPublish!==false){d.addCallbacks(function(res){_1.publish("/dojo/io/load",[d,res]);return res;},function(res){_1.publish("/dojo/io/error",[d,res]);return res;});d.addBoth(function(res){_1.publish("/dojo/io/done",[d,res]);return res;});}d.ioArgs=_27;return d;};var _31=function(dfd){dfd.canceled=true;var xhr=dfd.ioArgs.xhr;var _32=typeof xhr.abort;if(_32=="function"||_32=="object"||_32=="unknown"){xhr.abort();}var err=dfd.ioArgs.error;if(!err){err=new Error("xhr cancelled");err.dojoType="cancel";}return err;};var _33=function(dfd){var ret=_1e[dfd.ioArgs.handleAs](dfd.ioArgs.xhr);return ret===undefined?null:ret;};var _34=function(_35,dfd){if(!dfd.ioArgs.args.failOk){console.error(_35);}return _35;};var _36=null;var _37=[];var _38=0;var _39=function(dfd){if(_38<=0){_38=0;if(_2.ioPublish&&_1.publish&&(!dfd||dfd&&dfd.ioArgs.args.ioPublish!==false)){_1.publish("/dojo/io/stop");}}};var _3a=function(){var now=(new Date()).getTime();if(!_1._blockAsync){for(var i=0,tif;i<_37.length&&(tif=_37[i]);i++){var dfd=tif.dfd;var _3b=function(){if(!dfd||dfd.canceled||!tif.validCheck(dfd)){_37.splice(i--,1);_38-=1;}else{if(tif.ioCheck(dfd)){_37.splice(i--,1);tif.resHandle(dfd);_38-=1;}else{if(dfd.startTime){if(dfd.startTime+(dfd.ioArgs.args.timeout||0)<now){_37.splice(i--,1);var err=new Error("timeout exceeded");err.dojoType="timeout";dfd.errback(err);dfd.cancel();_38-=1;}}}}};if(dojo.config.debugAtAllCosts){_3b.call(this);}else{try{_3b.call(this);}catch(e){dfd.errback(e);}}}}_39(dfd);if(!_37.length){clearInterval(_36);_36=null;return;}};dojo._ioCancelAll=function $DBOc_(){try{_1.forEach(_37,function(i){try{i.dfd.cancel();}catch(e){}});}catch(e){}};if(_1.isIE){_1.addOnWindowUnload(_1._ioCancelAll);}_1._ioNotifyStart=function $DBOd_(dfd){if(_2.ioPublish&&_1.publish&&dfd.ioArgs.args.ioPublish!==false){if(!_38){_1.publish("/dojo/io/start");}_38+=1;_1.publish("/dojo/io/send",[dfd]);}};_1._ioWatch=function $DBOe_(dfd,_3c,_3d,_3e){var _3f=dfd.ioArgs.args;if(_3f.timeout){dfd.startTime=(new Date()).getTime();}_37.push({dfd:dfd,validCheck:_3c,ioCheck:_3d,resHandle:_3e});if(!_36){_36=setInterval(_3a,50);}if(_3f.sync){_3a();}};var _40="application/x-www-form-urlencoded";var _41=function(dfd){return dfd.ioArgs.xhr.readyState;};var _42=function(dfd){return 4==dfd.ioArgs.xhr.readyState;};var _43=function(dfd){var xhr=dfd.ioArgs.xhr;if(_1._isDocumentOk(xhr)){dfd.callback(dfd);}else{var err=new Error("Unable to load "+dfd.ioArgs.url+" status:"+xhr.status);err.status=xhr.status;err.responseText=xhr.responseText;dfd.errback(err);}};dojo._ioAddQueryToUrl=function $DBOf_(_44){if(_44.query.length){_44.url+=(_44.url.indexOf("?")==-1?"?":"&")+_44.query;_44.query=null;}};dojo.xhr=function $DBOg_(_45,_46,_47){var dfd=_1._ioSetArgs(_46,_31,_33,_34);var _48=dfd.ioArgs;var xhr=_48.xhr=_1._xhrObj(_48.args);if(!xhr){dfd.cancel();return dfd;}if("postData" in _46){_48.query=_46.postData;}else{if("putData" in _46){_48.query=_46.putData;}else{if("rawBody" in _46){_48.query=_46.rawBody;}else{if((arguments.length>2&&!_47)||"POST|PUT".indexOf(_45.toUpperCase())==-1){_1._ioAddQueryToUrl(_48);}}}}xhr.open(_45,_48.url,_46.sync!==true,_46.user||undefined,_46.password||undefined);if(_46.headers){for(var hdr in _46.headers){if(hdr.toLowerCase()==="content-type"&&!_46.contentType){_46.contentType=_46.headers[hdr];}else{if(_46.headers[hdr]){xhr.setRequestHeader(hdr,_46.headers[hdr]);}}}}xhr.setRequestHeader("Content-Type",_46.contentType||_40);if(!_46.headers||!("X-Requested-With" in _46.headers)){xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");}_1._ioNotifyStart(dfd);if(dojo.config.debugAtAllCosts){xhr.send(_48.query);}else{try{xhr.send(_48.query);}catch(e){_48.error=e;dfd.cancel();}}_1._ioWatch(dfd,_41,_42,_43);xhr=null;return dfd;};dojo.xhrGet=function $DBOh_(_49){return _1.xhr("GET",_49);};dojo.rawXhrPost=dojo.xhrPost=function(_4a){return _1.xhr("POST",_4a,true);};dojo.rawXhrPut=dojo.xhrPut=function(_4b){return _1.xhr("PUT",_4b,true);};dojo.xhrDelete=function $DBOi_(_4c){return _1.xhr("DELETE",_4c);};})();}