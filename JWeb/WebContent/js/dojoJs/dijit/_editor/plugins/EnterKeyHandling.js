/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dijit._editor.plugins.EnterKeyHandling"]){dojo._hasResource["dijit._editor.plugins.EnterKeyHandling"]=true;dojo.provide("dijit._editor.plugins.EnterKeyHandling");dojo.require("dijit._base.scroll");dojo.declare("dijit._editor.plugins.EnterKeyHandling",dijit._editor._Plugin,{blockNodeForEnter:"BR",constructor:function $DQv_(_1){if(_1){dojo.mixin(this,_1);}},setEditor:function $DQw_(_2){this.editor=_2;if(this.blockNodeForEnter=="BR"){if(dojo.isIE){_2.contentDomPreFilters.push(dojo.hitch(this,"regularPsToSingleLinePs"));_2.contentDomPostFilters.push(dojo.hitch(this,"singleLinePsToRegularPs"));_2.onLoadDeferred.addCallback(dojo.hitch(this,"_fixNewLineBehaviorForIE"));}else{_2.onLoadDeferred.addCallback(dojo.hitch(this,function(d){try{this.editor.document.execCommand("insertBrOnReturn",false,true);}catch(e){}return d;}));}}else{if(this.blockNodeForEnter){dojo["require"]("dijit._editor.range");var h=dojo.hitch(this,this.handleEnterKey);_2.addKeyHandler(13,0,0,h);_2.addKeyHandler(13,0,1,h);this.connect(this.editor,"onKeyPressed","onKeyPressed");}}},onKeyPressed:function $DQx_(e){if(this._checkListLater){if(dojo.withGlobal(this.editor.window,"isCollapsed",dijit)){var _3=dojo.withGlobal(this.editor.window,"getAncestorElement",dijit._editor.selection,["LI"]);if(!_3){dijit._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var _4=dojo.withGlobal(this.editor.window,"getAncestorElement",dijit._editor.selection,[this.blockNodeForEnter]);if(_4){_4.innerHTML=this.bogusHtmlContent;if(dojo.isIE){var r=this.editor.document.selection.createRange();r.move("character",-1);r.select();}}else{console.error("onKeyPressed: Cannot find the new block node");}}else{if(dojo.isMoz){if(_3.parentNode.parentNode.nodeName=="LI"){_3=_3.parentNode.parentNode;}}var fc=_3.firstChild;if(fc&&fc.nodeType==1&&(fc.nodeName=="UL"||fc.nodeName=="OL")){_3.insertBefore(fc.ownerDocument.createTextNode(" "),fc);var _5=dijit.range.create(this.editor.window);_5.setStart(_3.firstChild,0);var _6=dijit.range.getSelection(this.editor.window,true);_6.removeAllRanges();_6.addRange(_5);}}}this._checkListLater=false;}if(this._pressedEnterInBlock){if(this._pressedEnterInBlock.previousSibling){this.removeTrailingBr(this._pressedEnterInBlock.previousSibling);}delete this._pressedEnterInBlock;}},bogusHtmlContent:"&nbsp;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function $DQy_(e){var _7,_8,_9,_a=this.editor.document,br;if(e.shiftKey){var _b=dojo.withGlobal(this.editor.window,"getParentElement",dijit._editor.selection);var _c=dijit.range.getAncestor(_b,this.blockNodes);if(_c){if(!e.shiftKey&&_c.tagName=="LI"){return true;}_7=dijit.range.getSelection(this.editor.window);_8=_7.getRangeAt(0);if(!_8.collapsed){_8.deleteContents();_7=dijit.range.getSelection(this.editor.window);_8=_7.getRangeAt(0);}if(dijit.range.atBeginningOfContainer(_c,_8.startContainer,_8.startOffset)){if(e.shiftKey){br=_a.createElement("br");_9=dijit.range.create(this.editor.window);_c.insertBefore(br,_c.firstChild);_9.setStartBefore(br.nextSibling);_7.removeAllRanges();_7.addRange(_9);}else{dojo.place(br,_c,"before");}}else{if(dijit.range.atEndOfContainer(_c,_8.startContainer,_8.startOffset)){_9=dijit.range.create(this.editor.window);br=_a.createElement("br");if(e.shiftKey){_c.appendChild(br);_c.appendChild(_a.createTextNode(" "));_9.setStart(_c.lastChild,0);}else{dojo.place(br,_c,"after");_9.setStartAfter(_c);}_7.removeAllRanges();_7.addRange(_9);}else{return true;}}}else{dijit._editor.RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>");}return false;}var _d=true;_7=dijit.range.getSelection(this.editor.window);_8=_7.getRangeAt(0);if(!_8.collapsed){_8.deleteContents();_7=dijit.range.getSelection(this.editor.window);_8=_7.getRangeAt(0);}var _e=dijit.range.getBlockAncestor(_8.endContainer,null,this.editor.editNode);var _f=_e.blockNode;if((this._checkListLater=(_f&&(_f.nodeName=="LI"||_f.parentNode.nodeName=="LI")))){if(dojo.isMoz){this._pressedEnterInBlock=_f;}if(/^(\s|&nbsp;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|\xA0)<\/span>)?(<br>)?$/.test(_f.innerHTML)){_f.innerHTML="";if(dojo.isWebKit){_9=dijit.range.create(this.editor.window);_9.setStart(_f,0);_7.removeAllRanges();_7.addRange(_9);}this._checkListLater=false;}return true;}if(!_e.blockNode||_e.blockNode===this.editor.editNode){try{dijit._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);}catch(e2){}_e={blockNode:dojo.withGlobal(this.editor.window,"getAncestorElement",dijit._editor.selection,[this.blockNodeForEnter]),blockContainer:this.editor.editNode};if(_e.blockNode){if(_e.blockNode!=this.editor.editNode&&(!(_e.blockNode.textContent||_e.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)){this.removeTrailingBr(_e.blockNode);return false;}}else{_e.blockNode=this.editor.editNode;}_7=dijit.range.getSelection(this.editor.window);_8=_7.getRangeAt(0);}var _10=_a.createElement(this.blockNodeForEnter);_10.innerHTML=this.bogusHtmlContent;this.removeTrailingBr(_e.blockNode);if(dijit.range.atEndOfContainer(_e.blockNode,_8.endContainer,_8.endOffset)){if(_e.blockNode===_e.blockContainer){_e.blockNode.appendChild(_10);}else{dojo.place(_10,_e.blockNode,"after");}_d=false;_9=dijit.range.create(this.editor.window);_9.setStart(_10,0);_7.removeAllRanges();_7.addRange(_9);if(this.editor.height){dijit.scrollIntoView(_10);}}else{if(dijit.range.atBeginningOfContainer(_e.blockNode,_8.startContainer,_8.startOffset)){dojo.place(_10,_e.blockNode,_e.blockNode===_e.blockContainer?"first":"before");if(_10.nextSibling&&this.editor.height){_9=dijit.range.create(this.editor.window);_9.setStart(_10.nextSibling,0);_7.removeAllRanges();_7.addRange(_9);dijit.scrollIntoView(_10.nextSibling);}_d=false;}else{if(dojo.isMoz){this._pressedEnterInBlock=_e.blockNode;}}}return _d;},removeTrailingBr:function $DQz_(_11){var _12=/P|DIV|LI/i.test(_11.tagName)?_11:dijit._editor.selection.getParentOfType(_11,["P","DIV","LI"]);if(!_12){return;}if(_12.lastChild){if((_12.childNodes.length>1&&_12.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(_12.lastChild.nodeValue))||_12.lastChild.tagName=="BR"){dojo.destroy(_12.lastChild);}}if(!_12.childNodes.length){_12.innerHTML=this.bogusHtmlContent;}},_fixNewLineBehaviorForIE:function $DQ0_(d){var doc=this.editor.document;if(doc.__INSERTED_EDITIOR_NEWLINE_CSS===undefined){var _13=dojo.create("style",{type:"text/css"},doc.getElementsByTagName("head")[0]);_13.styleSheet.cssText="p{margin:0;}";this.editor.document.__INSERTED_EDITIOR_NEWLINE_CSS=true;}return d;},regularPsToSingleLinePs:function $DQ1_(_14,_15){function wrapLinesInPs(el){function wrapNodes(_16){var _17=_16[0].ownerDocument.createElement("p");_16[0].parentNode.insertBefore(_17,_16[0]);dojo.forEach(_16,function(_18){_17.appendChild(_18);});};var _19=0;var _1a=[];var _1b;while(_19<el.childNodes.length){_1b=el.childNodes[_19];if(_1b.nodeType==3||(_1b.nodeType==1&&_1b.nodeName!="BR"&&dojo.style(_1b,"display")!="block")){_1a.push(_1b);}else{var _1c=_1b.nextSibling;if(_1a.length){wrapNodes(_1a);_19=(_19+1)-_1a.length;if(_1b.nodeName=="BR"){dojo.destroy(_1b);}}_1a=[];}_19++;}if(_1a.length){wrapNodes(_1a);}};function splitP(el){var _1d=null;var _1e=[];var _1f=el.childNodes.length-1;for(var i=_1f;i>=0;i--){_1d=el.childNodes[i];if(_1d.nodeName=="BR"){var _20=_1d.ownerDocument.createElement("p");dojo.place(_20,el,"after");if(_1e.length==0&&i!=_1f){_20.innerHTML="&nbsp;";}dojo.forEach(_1e,function(_21){_20.appendChild(_21);});dojo.destroy(_1d);_1e=[];}else{_1e.unshift(_1d);}}};var _22=[];var ps=_14.getElementsByTagName("p");dojo.forEach(ps,function(p){_22.push(p);});dojo.forEach(_22,function(p){var _23=p.previousSibling;if((_23)&&(_23.nodeType==1)&&(_23.nodeName=="P"||dojo.style(_23,"display")!="block")){var _24=p.parentNode.insertBefore(this.document.createElement("p"),p);_24.innerHTML=_15?"":"&nbsp;";}splitP(p);},this.editor);wrapLinesInPs(_14);return _14;},singleLinePsToRegularPs:function $DQ2_(_25){function getParagraphParents(_26){var ps=_26.getElementsByTagName("p");var _27=[];for(var i=0;i<ps.length;i++){var p=ps[i];var _28=false;for(var k=0;k<_27.length;k++){if(_27[k]===p.parentNode){_28=true;break;}}if(!_28){_27.push(p.parentNode);}}return _27;};function isParagraphDelimiter(_29){return (!_29.childNodes.length||_29.innerHTML=="&nbsp;");};var _2a=getParagraphParents(_25);for(var i=0;i<_2a.length;i++){var _2b=_2a[i];var _2c=null;var _2d=_2b.firstChild;var _2e=null;while(_2d){if(_2d.nodeType!=1||_2d.tagName!="P"||(_2d.getAttributeNode("style")||{}).specified){_2c=null;}else{if(isParagraphDelimiter(_2d)){_2e=_2d;_2c=null;}else{if(_2c==null){_2c=_2d;}else{if((!_2c.lastChild||_2c.lastChild.nodeName!="BR")&&(_2d.firstChild)&&(_2d.firstChild.nodeName!="BR")){_2c.appendChild(this.editor.document.createElement("br"));}while(_2d.firstChild){_2c.appendChild(_2d.firstChild);}_2e=_2d;}}}_2d=_2d.nextSibling;if(_2e){dojo.destroy(_2e);_2e=null;}}}return _25;}});}